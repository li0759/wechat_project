<!--pages/club/club-financial-stats/index.wxml-->
<view class="container">
  <view class="page-header">
    <view class="title-group">
      <view class="title">æ”¶æ”¯ç»Ÿè®¡</view>
      <view class="subtitle" wx:if="{{clubInfo.club_name}}">{{clubInfo.club_name}}</view>
    </view>
    <view class="header-actions">
      <van-button 
        type="primary" 
        round 
        size="small" 
        icon="down" 
        bindtap="downloadExcel"
        loading="{{downloading}}"
        class="download-btn"
      >
        ä¸‹è½½Excel
      </van-button>
    </view>
  </view>
  
  <view wx:if="{{loading}}" class="loading-container">
    <van-loading size="24px" type="spinner" color="#df76b0" />
    <view class="loading-text">æ­£åœ¨åŠ è½½æ•°æ®...</view>
  </view>
  
  <view wx:else class="content">
    <!-- æ€»ä½“ç»Ÿè®¡å¡ç‰‡ -->
    <view class="stats-overview">
      <view class="stats-card">
        <view class="stats-number">Â¥{{totalIncome}}</view>
        <view class="stats-label">æ€»æ”¶å…¥</view>
      </view>
      <view class="stats-card">
        <view class="stats-number">Â¥{{totalExpenses}}</view>
        <view class="stats-label">æ€»æ”¯å‡º</view>
      </view>
      <view class="stats-card">
        <view class="stats-number {{netBalance >= 0 ? 'positive' : 'negative'}}">Â¥{{netBalance}}</view>
        <view class="stats-label">å‡€æ”¶æ”¯</view>
      </view>
      <view class="stats-card">
        <view class="stats-number">Â¥{{paygroupIncome}}</view>
        <view class="stats-label">ç¼´è´¹æ”¶å…¥</view>
      </view>
    </view>
    
    <!-- å›¾è¡¨å±•ç¤ºåŒºåŸŸ -->
    <view class="charts-section" wx:if="{{!hideCharts}}">
      <!-- æœˆåº¦æ”¶å…¥è¶‹åŠ¿å›¾ -->
      <view class="chart-container" wx:if="{{monthlyIncomeChart.length > 0}}">
        <bar-chart 
          data="{{monthlyIncomeChart}}" 
          title="æœˆåº¦æ”¶å…¥è¶‹åŠ¿"
          height="{{280}}"
          bar-color="#67c23a"
          show-value="{{true}}"
        />
      </view>
      
      <!-- æœˆåº¦æ”¯å‡ºè¶‹åŠ¿å›¾ -->
      <view class="chart-container" wx:if="{{monthlyExpenseChart.length > 0}}">
        <bar-chart 
          data="{{monthlyExpenseChart}}" 
          title="æœˆåº¦æ”¯å‡ºè¶‹åŠ¿"
          height="{{280}}"
          bar-color="#f56c6c"
          show-value="{{true}}"
        />
      </view>
      
      <!-- æ”¶å…¥æ„æˆé¥¼å›¾ -->
      <view class="chart-container" wx:if="{{incomeChart.length > 0}}">
        <pie-chart 
          data="{{incomeChart}}" 
          title="æ”¶å…¥æ„æˆåˆ†å¸ƒ"
          height="{{280}}"
          colors="{{['#67c23a', '#5fb3d4', '#f4b844', '#9c88ff', '#df76b0']}}"
        />
      </view>
      
      <!-- æ”¯å‡ºæ„æˆé¥¼å›¾ -->
      <view class="chart-container" wx:if="{{expenseChart.length > 0}}">
        <pie-chart 
          data="{{expenseChart}}" 
          title="æ”¯å‡ºæ„æˆåˆ†å¸ƒ"
          height="{{280}}"
          colors="{{['#f56c6c', '#e6a23c', '#909399', '#409eff', '#df76b0']}}"
        />
      </view>
    </view>
    
    <!-- æ”¶å…¥æ˜ç»†åˆ—è¡¨ -->
    <view class="list-section">
      <view class="section-title">
        <view class="title-text">æ”¶å…¥æ˜ç»†</view>
        <view class="title-desc">å…±{{incomeDetails.paygroups ? incomeDetails.paygroups.length : 0}}é¡¹</view>
      </view>
      
      <view class="financial-list" wx:if="{{incomeDetails.paygroups && incomeDetails.paygroups.length > 0}}">
        <view class="financial-item income" wx:for="{{incomeDetails.paygroups}}" wx:key="group_id">
          <view class="financial-header">
            <view class="financial-title">{{item.description || 'ç¼´è´¹é¡¹ç›®'}}</view>
            <view class="financial-id">#{{item.group_id}}</view>
          </view>
          <view class="financial-info">
            <view class="info-row">
              <text class="info-label">åº”æ”¶é‡‘é¢:</text>
              <text class="info-value">Â¥{{item.total_payment}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">å·²æ”¶é‡‘é¢:</text>
              <text class="info-value amount">Â¥{{item.paid_amount}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">æœªæ”¶é‡‘é¢:</text>
              <text class="info-value unpaid">Â¥{{item.unpaid_amount}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">åˆ›å»ºæ—¥æœŸ:</text>
              <text class="info-value">{{item.create_date}}</text>
            </view>
          </view>
          <view class="financial-stats">
            <view class="stat-item">
              <text class="stat-value">{{item.participants_count}}</text>
              <text class="stat-label">å‚ä¸äººæ•°</text>
            </view>
            <view class="stat-item">
              <text class="stat-value">{{item.paid_participants}}</text>
              <text class="stat-label">å·²ç¼´è´¹</text>
            </view>
            <view class="stat-item">
              <text class="stat-value">{{Math.round(item.paid_participants/item.participants_count*100) || 0}}%</text>
              <text class="stat-label">ç¼´è´¹ç‡</text>
            </view>
          </view>
        </view>
      </view>
      
      <view wx:else class="empty-state">
        <view class="empty-icon">ğŸ’°</view>
        <view class="empty-text">æš‚æ— æ”¶å…¥æ•°æ®</view>
        <view class="empty-desc">è¯¥åä¼šè¿˜æ²¡æœ‰æ”¶å…¥è®°å½•</view>
      </view>
    </view>
    
    <!-- æ”¯å‡ºæ˜ç»†åˆ—è¡¨ -->
    <view class="list-section">
      <view class="section-title">
        <view class="title-text">æ”¯å‡ºæ˜ç»†</view>
        <view class="title-desc">åä¼šè´¹ç”¨ + æ´»åŠ¨è´¹ç”¨</view>
      </view>
      
      <view class="financial-list" wx:if="{{expenseDetails.club_fees || expenseDetails.event_costs}}">
        <!-- åä¼šè´¹ç”¨ -->
        <view class="financial-item expense" wx:for="{{expenseDetails.club_fees}}" wx:key="fee_id" wx:if="{{expenseDetails.club_fees && expenseDetails.club_fees.length > 0}}">
          <view class="financial-header">
            <view class="financial-title">åä¼šæ—¥å¸¸æ”¯å‡º</view>
            <view class="financial-id">#{{item.fee_id}}</view>
          </view>
          <view class="financial-info">
            <view class="info-row">
              <text class="info-label">æ”¯å‡ºé‡‘é¢:</text>
              <text class="info-value amount">Â¥{{item.amount}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">æ”¯å‡ºæ—¥æœŸ:</text>
              <text class="info-value">{{item.create_date}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">æ”¯å‡ºæè¿°:</text>
              <text class="info-value">{{item.description || 'æ— æè¿°'}}</text>
            </view>
          </view>
        </view>
        
        <!-- æ´»åŠ¨è´¹ç”¨ -->
        <view class="financial-item expense" wx:for="{{expenseDetails.event_costs}}" wx:key="event_id" wx:if="{{expenseDetails.event_costs && expenseDetails.event_costs.length > 0}}">
          <view class="financial-header">
            <view class="financial-title">{{item.title}}</view>
            <view class="financial-id">#{{item.event_id}}</view>
          </view>
          <view class="financial-info">
            <view class="info-row">
              <text class="info-label">æ´»åŠ¨è´¹ç”¨:</text>
              <text class="info-value amount">Â¥{{item.amount}}</text>
            </view>
            <view class="info-row">
              <text class="info-label">æ´»åŠ¨æ—¥æœŸ:</text>
              <text class="info-value">{{item.date}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view wx:else class="empty-state">
        <view class="empty-icon">ğŸ“Š</view>
        <view class="empty-text">æš‚æ— æ”¯å‡ºæ•°æ®</view>
        <view class="empty-desc">è¯¥åä¼šè¿˜æ²¡æœ‰æ”¯å‡ºè®°å½•</view>
      </view>
    </view>
    
    <!-- æœˆåº¦ç»Ÿè®¡åˆ—è¡¨ -->
    <view class="list-section" wx:if="{{monthlyStatistics.length > 0}}">
      <view class="section-title">
        <view class="title-text">æœˆåº¦ç»Ÿè®¡</view>
        <view class="title-desc">è¿‘{{monthlyStatistics.length}}ä¸ªæœˆ</view>
      </view>
      
      <view class="monthly-list">
        <view class="monthly-item" wx:for="{{monthlyStatistics}}" wx:key="month">
          <view class="monthly-header">
            <view class="monthly-month">{{item.month}}</view>
            <view class="monthly-balance {{item.net_balance >= 0 ? 'positive' : 'negative'}}">
              {{item.net_balance >= 0 ? '+' : ''}}Â¥{{item.net_balance}}
            </view>
          </view>
          <view class="monthly-details">
            <view class="detail-item income">
              <text class="detail-label">æ”¶å…¥:</text>
              <text class="detail-value">Â¥{{item.income}}</text>
            </view>
            <view class="detail-item expense">
              <text class="detail-label">æ”¯å‡º:</text>
              <text class="detail-value">Â¥{{item.expenses}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
</view> 