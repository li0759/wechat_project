<view class="event-container">
  <van-tabs active="{{ activeTab }}" bind:change="onTabChange" sticky animated swipeable>
    <!-- 缴费记录选项卡 -->
    <van-tab title="缴费记录" class="list-tab">
      <!-- 固定在顶部的年月显示 - 只在收款记录选项卡中显示 -->
      <view class="fixed-month-display" wx:if="{{ activeTab === 0 }}">
        <text>{{ listDisplayYear || currentYear }}年{{ listDisplayMonth || currentMonth }}月</text>
      </view>
      
      <!-- 内容区域 -->
      <view class="list-content">
        <view class="waterfall-container">

          <view class="full-width-column">
            <!-- 缴费记录时间轴 -->
            <scroll-view 
              scroll-y 
              class="timeline-scroll-view" 
              bindscroll="onTimelineScroll"
              scroll-with-animation
              enhanced
              show-scrollbar="{{false}}"
              style="height: 90vh;"
            >
              <view class="timeline-main-container">
                <!-- 中间时间轴 -->
                <view class="timeline-center">
                  <view class="timeline-line"></view>
                </view>

                <!-- 时间轴内容区 -->
                <view class="timeline-items">
                  <block wx:for="{{ timeline }}" wx:key="index">
                    <!-- 缴费项目（左侧显示未支付，右侧显示已支付） -->
                    <block wx:if="{{ !item.isPaid }}">
                      <view class="timeline-item income-item" data-index="{{index}}" data-date="{{item.create_date}}">
                        <view class="timeline-content">
                          <view class="pay-group">
                            <view class="pay-description">{{ item.description }}</view>
                            <view class="pay-amount">
                              <text class="unpaid">应付: ¥{{ item.payment }}</text>
                            </view>
                            <!-- 创建日期 -->
                            <view class="item-date-inside">{{ item.create_date }}</view>
                            <view class="pay-status unpaid-status">
                              <text>待支付</text>
                            </view>
                          </view>
                        </view>
                        <view class="timeline-dot"></view>
                      </view>
                    </block>

                    <block wx:else>
                      <view class="timeline-item expense-item" data-index="{{index}}" data-date="{{item.create_date}}">
                        <view class="timeline-dot"></view>
                        <view class="timeline-content">
                          <view class="club-fee">
                            <view class="fee-description">{{ item.description }}</view>
                            <view class="fee-amount">¥{{ item.payment }}</view>
                            <!-- 支付日期 -->
                            <view class="pay-status paid-status">
                              <text>已支付</text>
                              <text class="pay-date" wx:if="{{item.pay_date}}">{{item.pay_date}}</text>
                            </view>
                          </view>
                          <!-- 创建日期 -->
                          <view class="item-date-inside">{{ item.create_date }}</view>
                        </view>
                      </view>
                    </block>
                  </block>
                  
                  <!-- 更换成点击加载更多按钮 - 移到时间轴内容内 -->
                  <view class="load-more-container" wx:if="{{ timeline.length > 0 }}">
                    <van-button 
                      round 
                      type="default" 
                      size="small" 
                      loading="{{ isLoading }}"
                      loading-type="spinner"
                      disabled="{{ !hasMore }}"
                      bind:click="onLoadMoreClick"
                      custom-class="load-more-btn"
                      icon="{{ hasMore ? 'arrow-down' : 'info-o' }}"
                    >
                      {{ isLoading ? '加载中...' : (hasMore ? '加载更多 (第' + currentPage + '/' + totalPages + '页)' : '已加载全部数据') }}
                    </van-button>
                  </view>
                </view>
              </view>
            </scroll-view>
            
            <!-- 无数据展示 -->
            <view wx:if="{{ timeline.length === 0 }}" class="empty-container">
              <van-empty description="暂无缴费记录" />
            </view>
          </view>
        </view>
      </view>
    </van-tab>
    
    <!-- 收支日历选项卡 -->
    <van-tab title="缴费日历">
      <view class="calendar-container">
        <!-- 日历组件 -->
        <calendar
          show="{{true}}"
          events="{{ calendarEvents || [] }}"
          bind:select="onCalendarSelect"
          bind:monthChange="onCalendarMonthChange"
        />
        <!-- 如果没有数据，显示提示 -->
        <view wx:if="{{ timeline.length === 0 }}" class="calendar-empty-tip">
          暂无收款数据可显示
        </view>
      </view>
    </van-tab>
  </van-tabs>
  
  <!-- 月份选择器弹窗 -->
  <van-popup
    show="{{ monthPickerVisible }}"
    position="bottom"
    round
    bind:close="closeMonthPicker"
  >
    <van-datetime-picker
      type="year-month"
      value="{{ monthPickerDate }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="confirmMonthPicker"
      bind:cancel="closeMonthPicker"
    />
  </van-popup>

  <!-- 显示未缴费数量的悬浮提示 -->
  <view class="unpaid-badge" wx:if="{{ unpaidCount > 0 }}">
    <text>您有 {{ unpaidCount }} 项待支付</text>
  </view>
</view> 