<!--packageClub/club-create/index.wxml-->
<view class="modern-container">

  <!-- 主要内容 -->
  <scroll-view class="main-scroll" scroll-y="true">
    <!-- 信息展示区 -->
    <view class="info-section">
      <!-- 协会基本信息卡片 -->
      <view class="card fade-in-up">
        <view class="create-info-card">
          <!-- 信息网格 -->
          <view class="create-info-grid">
            <!-- 协会名称 - 双倍宽度 -->
            <view class="create-info-item double-width" bindtap="editClubName">
              <van-icon name="shop-o" size="24" color="#ff6b9d" />
              <view class="create-info-content">
                <view class="create-info-label">协会名称</view>
                <view class="create-info-value">{{formData.club_name || '点击填写'}}</view>
              </view>
            </view>
            
            <!-- 选择会长 - 单个块 -->
            <view class="create-info-item single-block" bindtap="editLeader">
              <van-icon name="manager-o" size="24" color="#ff6b9d" />
              <view class="create-info-content">
                <view class="create-info-label">协会会长</view>
                <view class="create-info-value">
                  <view wx:if="{{selectedLeader}}" class="selected-leader">
                    <image class="leader-avatar" src="{{selectedLeader.avatar || '/assets/icons/user.png'}}" />
                    <text class="leader-name">{{selectedLeader.name}}</text>
                  </view>
                  <text wx:else>点击选择会长</text>
                </view>
              </view>
            </view>
            
            <!-- 协会图片 - 单个块 -->
            <view class="create-info-item single-block" bindtap="editImages">
              <van-icon name="photo-o" size="24" color="#ff6b9d" />
              <view class="create-info-content">
                <view class="create-info-label">协会图片</view>
                <view class="create-info-value">
                  {{dragImgCount > 0 ? '已添加图片 (' + dragImgCount + '张)' : '点击添加'}}
                </view>
              </view>
            </view>
            
            <!-- 协会简介 - 双倍宽度 -->
            <view class="create-info-item double-width" bindtap="editDescription">
              <van-icon name="description" size="24" color="#ff6b9d" />
              <view class="create-info-content">
                <view class="create-info-label">协会简介</view>
                <view class="create-info-value description-text">{{formData.description || '点击填写'}}</view>
              </view>
            </view>
            
            <!-- 协会章程 - 双倍宽度和高度 -->
            <view class="create-info-item double-width double-height" bindtap="editCharter">
              <van-icon name="notes-o" size="24" color="#ff6b9d" />
              <view class="create-info-content">
                <view class="create-info-label">协会章程</view>
                <view class="create-info-value description-text">{{formData.charter || '点击填写'}}</view>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- 操作区 -->
      <view class="action-section fade-in-up-delay-1">
        <view class="actions-container">
          <view class="action-btn secondary" bindtap="navigateBack">
            <van-icon name="cross" size="20" />
            <text>退出编辑</text>
          </view>
          
          <view class="action-btn primary" bindtap="submitForm">
            <van-icon name="success" size="20" />
            <text>创建协会</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>

  <!-- 编辑弹窗 -->
  <!-- 协会名称编辑弹窗 -->
  <van-popup 
    show="{{ showClubNamePopup }}" 
    position="bottom" 
    round
    close-on-click-overlay
    bind:close="closeClubNamePopup"
    custom-class="club-name-popup"
    z-index="2000"
    safe-area-inset-bottom
  >
    <view class="popup-container">
      <view class="popup-header">
        <text class="popup-title">协会名称</text>
        <van-icon name="cross" bind:click="closeClubNamePopup" color="#666" />
      </view>
      
      <view class="popup-content">
        <van-field
          value="{{ tempClubName }}"
          placeholder="请输入协会名称"
          border="{{ false }}"
          bind:change="onTempClubNameChange"
          maxlength="50"
          show-word-limit
        />
        
        <view class="popup-actions">
          <view class="action-btn primary" bindtap="confirmClubName">
            <van-icon name="success" size="16" />
            <text>确认</text>
          </view>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- 选择会长弹窗 -->
  <van-popup 
    show="{{ showLeaderPopup }}" 
    position="bottom" 
    round
    close-on-click-overlay
    bind:close="closeLeaderPopup"
    custom-class="leader-popup"
    custom-style="height: 70vh;"
    z-index="2000"
    safe-area-inset-bottom
  >
    <view class="popup-container">
      <view class="popup-header">
        <text class="popup-title">选择协会会长</text>
        <van-icon name="cross" bind:click="closeLeaderPopup" color="#666" />
      </view>
      
      <view class="popup-content">
        <!-- 已选择的会长显示 -->
        <view class="selected-leader-display" wx:if="{{tempSelectedLeader}}">
          <view class="selected-leader-card">
            <image class="selected-avatar" src="{{tempSelectedLeader.avatar || '/assets/icons/user.png'}}" />
            <view class="selected-info">
              <view class="selected-name">{{tempSelectedLeader.name}}</view>
              <view class="selected-desc">{{tempSelectedLeader.description || '暂无描述'}}</view>
            </view>
            <view class="clear-selection" bindtap="clearLeaderSelection">
              <van-icon name="cross" size="16" color="#999" />
            </view>
          </view>
        </view>
        
        <view class="search-section">
          <search-suggest 
            id="leaderSearchSuggest"
            placeholder="搜索用户姓名、手机号、邮箱..."
            themeColor="#ff6b9d"
            shape="round"
            enableAutocomplete="{{true}}"
            showHistory="{{true}}"
            maxSuggestions="{{8}}"
            debounceTime="{{300}}"
            minSearchLength="{{1}}"
            bind:search="onLeaderSearch"
            bind:fetchSuggestions="onFetchLeaderSuggestions"
            bind:select="onSelectLeaderSuggestion"
            bind:historySelect="onLeaderHistorySelect"
          />
        </view>
        
        <!-- 搜索结果显示 -->
        <view class="search-results" wx:if="{{leaderSearchResults && leaderSearchResults.length > 0}}">
          <view 
            class="search-result-item" 
            wx:for="{{leaderSearchResults}}" 
            wx:key="user_id"
            bindtap="selectLeaderFromSearch"
            data-user="{{item}}"
          >
            <view class="user-info">
              <image 
                class="user-avatar" 
                src="{{item.avatar || '/assets/icons/user.png'}}" 
              />
              <view class="user-details">
                <view class="user-name">{{item.user_name}}</view>
                <view class="user-phone">{{item.phone}}</view>
              </view>
            </view>
            <!-- 协会信息显示在右边 -->
            <view class="user-right-info">
              <view class="user-clubs-tag" wx:if="{{item.tag}}">
                <text class="clubs-summary">{{item.tag}}</text>
              </view>
            </view>
            <view class="select-user-btn">
                <van-icon name="arrow" size="16" color="#ff6b9d" />
            </view>
          </view>
        </view>
        
        <view class="popup-actions" wx:if="{{tempSelectedLeader}}">
          <view class="action-btn primary" bindtap="confirmLeader">
            <van-icon name="success" size="16" />
            <text>确认选择</text>
          </view>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- 协会简介编辑弹窗 -->
  <van-popup 
    show="{{ showDescriptionPopup }}" 
    position="bottom" 
    round
    close-on-click-overlay
    bind:close="closeDescriptionPopup"
    custom-class="description-popup"
    z-index="2000"
    safe-area-inset-bottom
  >
    <view class="popup-container">
      <view class="popup-header">
        <text class="popup-title">协会简介</text>
        <van-icon name="cross" bind:click="closeDescriptionPopup" color="#666" />
      </view>
      
      <view class="popup-content">
        <van-field
          value="{{ tempDescription }}"
          type="textarea"
          placeholder="请输入协会简介..."
          border="{{ false }}"
          bind:change="onTempDescriptionChange"
          maxlength="500"
          show-word-limit
          autosize
        />
        
        <view class="popup-actions">
          <view class="action-btn primary" bindtap="confirmDescription">
            <van-icon name="success" size="16" />
            <text>确认</text>
          </view>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- 协会章程编辑弹窗 -->
  <van-popup 
    show="{{ showCharterPopup }}" 
    position="bottom" 
    round
    close-on-click-overlay
    bind:close="closeCharterPopup"
    custom-class="charter-popup"
    z-index="2000"
    safe-area-inset-bottom
  >
    <view class="popup-container">
      <view class="popup-header">
        <text class="popup-title">协会章程</text>
        <van-icon name="cross" bind:click="closeCharterPopup" color="#666" />
      </view>
      
      <view class="popup-content">
        <van-field
          value="{{ tempCharter }}"
          type="textarea"
          placeholder="请输入协会章程..."
          border="{{ false }}"
          bind:change="onTempCharterChange"
          maxlength="2000"
          show-word-limit
          autosize
        />
        
        <view class="popup-actions">
          <view class="action-btn primary" bindtap="confirmCharter">
            <van-icon name="success" size="16" />
            <text>确认</text>
          </view>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- 图片管理弹窗 -->
  <van-popup 
    show="{{ showImagePopup }}" 
    position="bottom" 
    round
    close-on-click-overlay
    bind:close="closeImagePopup"
    custom-class="image-popup"
    z-index="2000"
    safe-area-inset-bottom
  >
    <view class="popup-container">
      <view class="popup-header">
        <text class="popup-title">管理协会图片</text>
        <van-icon name="cross" bind:click="closeImagePopup" color="#666" />
      </view>
      
      <view class="popup-content">
        <view class="images-tip">
          <van-icon name="info-o" size="14" color="#ff6b9d" />
          <text>拖拽调整顺序，第一张将自动作为封面图</text>
        </view>
        
        <drag-img 
          id="drag-img"
          previewSize="90" 
          defaultImgList="{{[]}}" 
          maxCount="9"
          columns="3"
          gap="10"
          customClass="drag-img-container"
          itemClass="drag-img-item"
          bind:listChange="onImageListUpdate"
        />
        
        <view class="popup-actions">
          <view class="action-btn primary" bindtap="confirmImages">
            <van-icon name="success" size="16" />
            <text>确认</text>
          </view>
        </view>
      </view>
    </view>
  </van-popup>
</view>