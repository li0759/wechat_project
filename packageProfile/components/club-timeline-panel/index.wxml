<!-- pages/money/club-timeline/index.wxml -->
<view class="event-container">
  <van-tabs active="{{ activeTab }}" bind:change="onTabChange" sticky animated swipeable>
    <!-- 收支记录选项卡 -->
    <van-tab title="收支记录" class="list-tab">
      <!-- 固定在顶部的年月显示 - 只在收支记录选项卡中显示 -->
      <view class="fixed-month-display" wx:if="{{ activeTab === 0 }}">
        <text>{{ listDisplayYear }}年{{ listDisplayMonth }}月</text>
      </view>
      
      <!-- 新增功能按钮区域 - 只在收支记录选项卡中显示 -->
      <view class="fixed-action-buttons" wx:if="{{ activeTab === 0 }}">
        <view class="action-button payment-button" bindtap="navigateToCreatePayment">
          <van-icon name="balance-o" size="32px" color="#ffffff" />
        </view>
        <view class="action-button clubfee-button" bindtap="navigateToCreateClubfee">
          <van-icon name="balance-list-o" size="32px" color="#ffffff" />
        </view>
      </view>
      
      <!-- 内容区域 -->
      <view class="list-content">
        <view class="waterfall-container">

          <view class="full-width-column">
            <!-- 收支记录时间轴 -->
            <scroll-view 
              scroll-y 
              class="timeline-scroll-view" 
              bindscroll="onTimelineScroll"
              scroll-with-animation
              enhanced
              show-scrollbar="{{false}}"
              style="height: 90vh;"
            >
              <view class="timeline-main-container">
                <!-- 中间时间轴 -->
                <view class="timeline-center">
                  <view class="timeline-line"></view>
                </view>

                <!-- 时间轴内容区 -->
                <view class="timeline-items">
                  <block wx:for="{{ timeline }}" wx:key="index">
                    <!-- 收入项目（显示在左侧） -->
                    <block wx:if="{{ item.type === 'pay_group' }}">
                      <view class="timeline-item income-item" data-index="{{index}}" data-date="{{item.create_date}}">
                        <view class="timeline-content">
                          <view class="pay-group">
                            <view class="pay-description">{{ item.description }}</view>
                            <view class="pay-amount">
                              <text class="paid">已收: ¥{{ item.paid }}</text>
                              <text class="unpaid">待收: ¥{{ item.unpaid }}</text>
                            </view>
                            <!-- 创建日期 -->
                            <view class="item-date-inside">{{ item.create_date }}</view>
                            <view class="pay-details-toggle" bindtap="showPayDetails" data-index="{{ index }}">
                              <text>查看详情</text>
                              <van-icon name="arrow-right" color="var(--income-color, rgb(223, 118, 176))" size="14px" />
                            </view>
                          </view>
                        </view>
                        <view class="timeline-dot"></view>
                      </view>
                    </block>

                    <!-- 支出项目（显示在右侧） -->
                    <block wx:if="{{ item.type === 'club_fee' || item.type === 'event_real_cost' }}">
                      <view class="timeline-item expense-item" data-index="{{index}}" data-date="{{item.create_date}}">
                        <view class="timeline-dot"></view>
                        <view class="timeline-content">
                          <!-- 活动支出 -->
                          <block wx:if="{{ item.type === 'event_real_cost' }}">
                            <view class="event-expense">
                              <image wx:if="{{ item.cover }}" class="event-cover" src="{{ item.cover }}" mode="aspectFill"></image>
                              <view class="event-info">
                                <view class="event-title">{{ item.title }}</view>
                                <view class="event-cost">¥{{ item.real_cost }}</view>
                              </view>
                            </view>
                          </block>
                          <!-- 自定义支出 -->
                          <block wx:if="{{ item.type === 'club_fee' }}">
                            <view class="club-fee">
                              <view class="fee-description">{{ item.description }}</view>
                              <view class="fee-amount">¥{{ item.feement }}</view>
                              <!-- 操作按钮组 -->
                              <view class="fee-actions">
                                <view class="fee-edit-btn" bindtap="editClubFee" data-fee-id="{{ item.id }}" data-feement="{{ item.feement }}" data-description="{{ item.description }}">
                                  <van-icon name="edit" size="16px" color="#0066cc" />
                                  <text class="edit-text">编辑</text>
                                </view>
                                <view class="fee-delete-btn" bindtap="deleteClubFee" data-fee-id="{{ item.id }}">
                                  <van-icon name="delete-o" size="16px" color="#ff4444" />
                                  <text class="delete-text">删除</text>
                                </view>
                              </view>
                            </view>
                          </block>
                          <!-- 创建日期 -->
                          <view class="item-date-inside">{{ item.create_date }}</view>
                        </view>
                      </view>
                    </block>
                  </block>
                  
                  <!-- 更换成点击加载更多按钮 - 移到时间轴内容内 -->
                  <view class="load-more-container" wx:if="{{ timeline.length > 0 }}">
                    <van-button 
                      round 
                      type="default" 
                      size="small" 
                      loading="{{ isLoading }}"
                      loading-type="spinner"
                      disabled="{{ !hasMore }}"
                      bind:click="onLoadMoreClick"
                      custom-class="load-more-btn"
                      icon="{{ hasMore ? 'arrow-down' : 'info-o' }}"
                    >
                      {{ isLoading ? '加载中...' : (hasMore ? '加载更多 (第' + currentPage + '/' + totalPages + '页)' : '已加载全部数据') }}
                    </van-button>
                  </view>
                </view>
              </view>
            </scroll-view>
            
            <!-- 无数据展示 -->
            <view wx:if="{{ timeline.length === 0 }}" class="empty-container">
              <van-empty description="暂无收支记录" />
            </view>
          </view>
        </view>
      </view>
    </van-tab>
    
    <!-- 收支日历选项卡 -->
    <van-tab title="收支日历">
      <view class="calendar-container">
        <!-- 日历组件 -->
        <calendar
          show="{{true}}"
          events="{{ calendarEvents || [] }}"
          bind:select="onCalendarSelect"
          bind:monthChange="onCalendarMonthChange"
        />
        <!-- 如果没有数据，显示提示 -->
        <view wx:if="{{ timeline.length === 0 }}" class="calendar-empty-tip">
          暂无收支数据可显示
        </view>
      </view>
    </van-tab>
  </van-tabs>
  
  <!-- 月份选择器弹窗 -->
  <van-popup
    show="{{ monthPickerVisible }}"
    position="bottom"
    round
    bind:close="closeMonthPicker"
  >
    <van-datetime-picker
      type="year-month"
      value="{{ monthPickerDate }}"
      min-date="{{ minDate }}"
      max-date="{{ maxDate }}"
      bind:confirm="confirmMonthPicker"
      bind:cancel="closeMonthPicker"
    />
  </van-popup>

  <!-- 添加支出模态框 -->
  <van-dialog
    use-slot
    title="添加支出"
    show="{{ expenseModalVisible }}"
    show-cancel-button
    confirm-button-color="var(--primary-color, rgb(223, 118, 176))"
    bind:close="closeExpenseModal"
    bind:confirm="confirmAddExpense"
  >
    <view class="modal-form">
      <van-field
        label="支出金额"
        type="digit"
        placeholder="请输入支出金额"
        model:value="{{ newExpense_feement }}"
      />
      <van-field
        label="支出描述"
        type="text"
        placeholder="请输入支出描述"
        model:value="{{ newExpense_description }}"
      />
      <!-- 添加日期选择器 -->
      <view class="form-item">
        <text class="form-label">支出日期</text>
        <view class="datetime-picker">
          <picker mode="date" value="{{newExpense_date}}" bindchange="onExpenseDateChange">
            <view class="picker-value {{newExpense_date ? '' : 'placeholder'}}">
              {{newExpense_date || '请选择日期'}}
            </view>
          </picker>
          <view class="datetime-separator">-</view>
          <picker mode="time" value="{{newExpense_time}}" bindchange="onExpenseTimeChange">
            <view class="picker-value {{newExpense_time ? '' : 'placeholder'}}">
              {{newExpense_time || '请选择时间'}}
            </view>
          </picker>
        </view>
      </view>
    </view>
  </van-dialog>

  <!-- 发起收款模态框 -->
  <van-dialog
    use-slot
    title="发起收款"
    show="{{ incomeModalVisible }}"
    show-cancel-button
    confirm-button-color="var(--primary-color, rgb(223, 118, 176))"
    bind:close="closeIncomeModal"
    bind:confirm="confirmAddIncome"
  >
    <view class="modal-form">
      <van-field
        label="收款总额"
        type="digit"
        placeholder="请输入收款总额"
        model:value="{{ newIncome_total_fee }}"
      />
      <van-field
        label="收款描述"
        type="text"
        placeholder="请输入收款描述"
        model:value="{{ newIncome_description }}"
      />
      <!-- 添加日期选择器 -->
      <view class="form-item">
        <text class="form-label">收款日期</text>
        <view class="datetime-picker">
          <picker mode="date" value="{{newIncome_date}}" bindchange="onIncomeDateChange">
            <view class="picker-value {{newIncome_date ? '' : 'placeholder'}}">
              {{newIncome_date || '请选择日期'}}
            </view>
          </picker>
          <view class="datetime-separator">-</view>
          <picker mode="time" value="{{newIncome_time}}" bindchange="onIncomeTimeChange">
            <view class="picker-value {{newIncome_time ? '' : 'placeholder'}}">
              {{newIncome_time || '请选择时间'}}
            </view>
          </picker>
        </view>
      </view>
    </view>
  </van-dialog>

  <!-- 收款详情弹窗 -->
  <van-dialog
    use-slot
    show="{{ payDetailsDialogVisible }}"
    title="收款详情"
    confirm-button-text="关闭"
    show-cancel-button="{{ false }}"
    confirm-button-color="var(--primary-color, rgb(223, 118, 176))"
    bind:close="closePayDetailsDialog"
  >
    <view class="pay-details-dialog">
      <view class="pay-details-dialog-title" wx:if="{{ currentPayGroup }}">{{ currentPayGroup.description }}</view>
      <view class="pay-details-dialog-content">
        <view class="pay-detail-item" wx:for="{{ currentPayGroupDetails }}" wx:key="index">
          <view class="payor-info">
            <image class="payor-avatar" wx:if="{{ item.payor.avatar }}" src="{{ item.payor.avatar }}"></image>
            <text class="payor-name">{{ item.payor.name }}</text>
          </view>
          <view class="payment-info">
            <text class="payment-amount">¥{{ item.personal_payment }}</text>
            <text class="payment-status {{ item.personal_paydate ? 'paid' : 'unpaid' }}">
              {{ item.personal_paydate ? '已支付' : '未支付' }}
            </text>
          </view>
        </view>
      </view>
    </view>
  </van-dialog>

  <!-- 创建支出弹窗 -->
  <van-popup 
    show="{{ showCreateClubfeePopup }}" 
    position="bottom" 
    round
    close-on-click-overlay
    bind:close="closeCreateClubfeePopup"
    custom-class="create-popup"
    z-index="2000"
    safe-area-inset-bottom
  >
    <view class="popup-container">
      <view class="popup-header">
        <text class="popup-title">创建支出</text>
        <van-icon name="cross" bind:click="closeCreateClubfeePopup" color="#666" />
      </view>
      
      <view class="popup-content">
        <!-- 支出信息区块 -->
        <view class="form-section">
          <view class="section-header">
            <van-icon name="balance-pay" color="rgb(223, 118, 176)" />
            <text class="section-title">支出信息</text>
          </view>
          
          <!-- 支出金额 -->
          <view class="form-item">
            <text class="form-label required">支出金额</text>
            <van-field
              value="{{ clubfeeForm.feement }}"
              placeholder="请输入支出金额"
              border="{{ false }}"
              bind:change="onClubfeeInputChange"
              data-field="feement"
              type="digit"
              custom-class="popup-field"
            />
          </view>
          
          <!-- 支出描述 -->
          <view class="form-item">
            <text class="form-label required">支出描述</text>
            <!-- 经费类型快速选择 -->
            <view class="expense-type-selector">
              <view class="type-options">
                <view class="type-option {{ clubfeeForm.description === '工会补助' ? 'active' : '' }}" 
                      bindtap="selectExpenseType" data-type="工会补助">
                  <text>工会补助</text>
                </view>
                <view class="type-option {{ clubfeeForm.description === '会员会费' ? 'active' : '' }}" 
                      bindtap="selectExpenseType" data-type="会员会费">
                  <text>会员会费</text>
                </view>
                <view class="type-option {{ clubfeeForm.description === '活动自筹' ? 'active' : '' }}" 
                      bindtap="selectExpenseType" data-type="活动自筹">
                  <text>活动自筹</text>
                </view>
              </view>
            </view>
            <van-field
              value="{{ clubfeeForm.description }}"
              placeholder="请输入支出描述或选择上方类型"
              border="{{ false }}"
              bind:change="onClubfeeInputChange"
              data-field="description"
              maxlength="100"
              show-word-limit
              custom-class="popup-field"
            />
          </view>
          
          <!-- 支出时间 -->
          <view class="form-item">
            <text class="form-label required">支出时间</text>
            <view class="datetime-container" bindtap="showClubfeeDatetimePicker">
              <text class="datetime-value {{ clubfeeForm.createDate ? '' : 'placeholder' }}">
                {{ clubfeeFormattedDate || '请选择日期时间' }}
              </text>
              <van-icon name="arrow" size="16" color="#666" />
            </view>
          </view>
        </view>
      </view>
      
      <!-- 操作按钮 -->
      <view class="popup-actions">
        <view class="action-btn secondary" bindtap="closeCreateClubfeePopup">
          <text>取消</text>
        </view>
        <view class="action-btn primary" bindtap="confirmCreateClubfee">
          <text>{{ clubfeeSubmitting ? '创建中...' : '创建支出' }}</text>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- 支出日期时间选择器 -->
  <van-popup
    show="{{ showClubfeeDatetimePicker }}"
    position="bottom"
    round
    bind:close="onClubfeeDateTimeCancel"
    z-index="2100"
  >
    <van-datetime-picker
      type="datetime"
      value="{{ clubfeeCurrentDate }}"
      min-date="{{ clubfeeMinDate }}"
      max-date="{{ clubfeeMaxDate }}"
      bind:confirm="onClubfeeDateTimeConfirm"
      bind:cancel="onClubfeeDateTimeCancel"
      title="请选择支出时间"
      visible-item-count="4"
    />
  </van-popup>

  <!-- 群收款弹窗 -->
  <van-popup show="{{showCreatePaymentPopup}}" 
             position="bottom" 
             closeable 
             close-on-click-overlay="{{true}}" 
             bind:close="closeCreatePaymentPopup"
             z-index="2500" 
             safe-area-inset-bottom="{{true}}" 
             custom-style="height: 85%; --van-popup-background-color: #f8f9fa;">
    <view class="popup-container">
      <view class="popup-header">
        <text class="popup-title">创建群收款</text>
        <van-icon name="cross" bind:click="closeCreatePaymentPopup" color="#666" />
      </view>
      
      <view class="popup-content">
        <!-- 日期选择区块 -->
        <view class="form-section">
          <view class="section-header">
            <van-icon name="calendar-o" color="rgb(223, 118, 176)" />
            <text class="section-title">日期选择</text>
          </view>
          
          <view class="form-item">
            <text class="form-label">选择日期范围查看支出记录</text>
            <view class="date-range-picker" bindtap="showPaymentCalendar">
              <view class="date-value">{{ paymentSelectedDateRange[0] }}</view>
              <view class="date-separator">至</view>
              <view class="date-value">{{ paymentSelectedDateRange[1] }}</view>
              <van-icon name="arrow" size="16" color="#666" />
            </view>
          </view>
        </view>

        <!-- 协会支出列表区块 -->
        <view class="form-section">
          <view class="section-header">
            <van-icon name="balance-list-o" color="rgb(223, 118, 176)" />
            <text class="section-title">协会支出列表</text>
            <!-- 总支出显示 -->
            <view wx:if="{{ paymentTotalExpense > 0 }}" class="total-expense">
              <text class="total-label">总支出：</text>
              <text class="total-amount">￥{{ paymentTotalExpense }}</text>
            </view>
          </view>
          
          <!-- 有支出记录时显示列表 -->
          <view wx:if="{{ paymentFeeList.length > 0 }}" class="fee-list">
            <scroll-view scroll-y class="fee-scroll-view">
              <view class="fee-item" wx:for="{{ paymentFeeList }}" wx:key="fee_id">
                <view class="fee-left">
                  <view class="fee-date">{{ item.create_date }}</view>
                  <view class="fee-desc">{{ item.description }}</view>
                </view>
                <view class="fee-amount">￥{{ item.feement }}</view>
              </view>
            </scroll-view>
            
            <!-- 支出统计汇总 -->
            <view class="fee-summary">
              <view class="summary-item">
                <text class="summary-label">支出笔数：</text>
                <text class="summary-value">{{ paymentFeeList.length }}笔</text>
              </view>
              <view class="summary-item total">
                <text class="summary-label">总计支出：</text>
                <text class="summary-value highlight">￥{{ paymentTotalExpense }}</text>
              </view>
            </view>
          </view>
          
          <!-- 无支出记录时显示提示 -->
          <view wx:else class="fee-empty">
            <van-empty description="该时间段内无支出记录" />
          </view>
        </view>

        <!-- 创建群收款表单区块 -->
        <view class="form-section">
          <view class="section-header">
            <van-icon name="bill-o" color="rgb(223, 118, 176)" />
            <text class="section-title">创建协会群收款</text>
          </view>
          
          <!-- 收款金额 -->
          <view class="form-item">
            <text class="form-label required">收款金额</text>
            <van-field
              value="{{ paymentForm.total_fee }}"
              placeholder="请输入收款总金额（将平分给所有成员）"
              border="{{ false }}"
              bind:change="onPaymentInputChange"
              data-field="total_fee"
              type="digit"
              custom-class="popup-field"
            />
          </view>
          
          <!-- 收款说明 -->
          <view class="form-item">
            <text class="form-label required">收款说明</text>
            <van-field
              value="{{ paymentForm.description }}"
              placeholder="请输入收款用途说明"
              border="{{ false }}"
              bind:change="onPaymentInputChange"
              data-field="description"
              maxlength="100"
              show-word-limit
              custom-class="popup-field"
            />
          </view>
          
          <!-- 收款日期 -->
          <view class="form-item">
            <text class="form-label required">收款日期</text>
            <picker mode="date" value="{{ paymentForm.createDate }}" bindchange="onPaymentDateChange" data-field="createDate">
              <view class="picker-value {{ paymentForm.createDate ? '' : 'placeholder' }}">
                {{ paymentForm.createDate || '选择日期' }}
              </view>
            </picker>
          </view>
        </view>
      </view>
      
      <!-- 操作按钮 -->
      <view class="popup-actions">
        <view class="action-btn secondary" bindtap="closeCreatePaymentPopup">
          <text>取消</text>
        </view>
        <view class="action-btn primary" bindtap="confirmCreatePayment">
          <text>{{ paymentSubmitting ? '创建中...' : '创建群收款' }}</text>
        </view>
      </view>
    </view>
  </van-popup>

  <!-- 独立的日历弹窗 - 参考 eventmanage 模式 -->
  <van-popup show="{{paymentCalendarShow}}" 
             position="bottom" 
             closeable 
             close-on-click-overlay="{{true}}" 
             bind:close="onPaymentCalendarClose"
             z-index="4000" 
             safe-area-inset-bottom="{{true}}"
             custom-style="height: 75%; --van-popup-background-color: white;">
    <van-calendar show="{{paymentCalendarShow}}"
                  type="range"
                  color="rgb(223, 118, 176)"
                  min-date="{{ paymentMinDate }}"
                  max-date="{{ paymentMaxDate }}"
                  default-date="{{ paymentDefaultDate }}"
                  bind:close="onPaymentCalendarClose"
                  bind:confirm="onPaymentCalendarConfirm"
                  show-title="{{true}}"
                  show-subtitle="{{true}}"
                  allow-same-day="{{true}}"
                  max-range="365"
                  safe-area-inset-bottom="{{false}}"
                  style="height: 100%; --van-calendar-popup-height: 100%;" />
  </van-popup>

  <!-- 编辑支出弹窗 -->
  <van-popup 
    show="{{ showEditClubfeePopup }}" 
    position="bottom" 
    round
    closeable
    close-on-click-overlay="{{true}}"
    bind:close="closeEditClubfeePopup"
    custom-class="create-popup"
    z-index="2200"
    safe-area-inset-bottom
  >
    <view class="popup-container">
      <view class="popup-header">
        <text class="popup-title">编辑支出</text>
        <van-icon name="cross" bind:click="closeEditClubfeePopup" color="#666" />
      </view>
      
      <view class="popup-content">
        <!-- 支出信息区块 -->
        <view class="form-section">
          <view class="section-header">
            <van-icon name="balance-pay" color="rgb(223, 118, 176)" />
            <text class="section-title">修改支出信息</text>
          </view>
          
          <!-- 支出金额 -->
          <view class="form-item">
            <text class="form-label required">支出金额</text>
            <van-field
              value="{{ editClubfeeForm.feement }}"
              placeholder="请输入支出金额"
              border="{{ false }}"
              bind:input="onEditClubfeeInputChange"
              data-field="feement"
              type="digit"
              custom-class="popup-field"
            />
          </view>
          
          <!-- 支出描述 -->
          <view class="form-item">
            <text class="form-label required">支出描述</text>
            <!-- 经费类型快速选择 -->
            <view class="expense-type-selector">
              <view class="type-options">
                <view class="type-option {{ editClubfeeForm.description === '工会补助' ? 'active' : '' }}" 
                      bindtap="selectEditExpenseType" data-type="工会补助">
                  <text>工会补助</text>
                </view>
                <view class="type-option {{ editClubfeeForm.description === '会员会费' ? 'active' : '' }}" 
                      bindtap="selectEditExpenseType" data-type="会员会费">
                  <text>会员会费</text>
                </view>
                <view class="type-option {{ editClubfeeForm.description === '活动自筹' ? 'active' : '' }}" 
                      bindtap="selectEditExpenseType" data-type="活动自筹">
                  <text>活动自筹</text>
                </view>
              </view>
            </view>
            <van-field
              value="{{ editClubfeeForm.description }}"
              placeholder="请输入支出描述或选择上方类型"
              border="{{ false }}"
              bind:input="onEditClubfeeInputChange"
              data-field="description"
              maxlength="100"
              show-word-limit
              custom-class="popup-field"
            />
          </view>
        </view>
      </view>
      
      <!-- 操作按钮 -->
      <view class="popup-actions">
        <view class="action-btn secondary" bindtap="closeEditClubfeePopup">
          <text>取消</text>
        </view>
        <view class="action-btn primary" bindtap="confirmEditClubfee">
          <text>{{ editClubfeeSubmitting ? '保存中...' : '保存修改' }}</text>
        </view>
      </view>
    </view>
  </van-popup>
</view> 