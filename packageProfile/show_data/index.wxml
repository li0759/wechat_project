<!--packageProfile/show_data/index.wxml-->
<view class="container">
  <!-- 加载状态 -->
  <view class="loading-container" wx:if="{{loading}}">
    <van-loading size="32px" color="#df76b0">加载统计数据中...</van-loading>
  </view>

  <!-- 错误状态 -->
  <view class="error-container" wx:elif="{{error}}">
    <van-empty
      image="error"
      description="{{error}}"
    >
      <view slot="button">
        <van-button type="primary" size="small" bindtap="loadAllData">重新加载</van-button>
      </view>
    </van-empty>
  </view>

  <!-- 主要内容 -->
  <view class="content" wx:else>
    <!-- 页面标题和操作栏 -->
    <view class="header-section">
      <view class="page-header">
        <view class="title-info">
          <text class="main-title">{{pageTitle}}</text>
          <text class="sub-title">{{dataType === 'user' ? '协会会员数据统计' : '活动数据统计分析'}}</text>
        </view>
        <view class="header-actions">
          <van-button
            type="primary"
            size="small"
            icon="exchange"
            bind:click="onSwitchDataType"
          >
            切换到{{dataType === 'user' ? '活动' : '用户'}}数据
          </van-button>
        </view>
      </view>
    </view>

    <!-- 统计卡片网格 -->
    <view class="stats-section">
      <view class="section-title">
        <van-icon name="chart-trending-o" size="20px" color="#df76b0" />
        <text>数据概览</text>
      </view>
      <view class="stats-grid">
        <stat-card
          wx:for="{{statCards}}"
          wx:key="title"
          title="{{item.title}}"
          value="{{item.value}}"
          unit="{{item.unit}}"
          icon="{{item.icon}}"
          color="{{item.color}}"
          trend="{{item.trend}}"
          bind:cardTap="onStatCardTap"
        />
      </view>
    </view>

    <!-- 图表展示区域 -->
    <view class="charts-section">
      <!-- 饼图 -->
      <view class="chart-container">
        <pie-chart
          data="{{pieChartData}}"
          title="{{dataType === 'user' ? '协会会员分布' : '各协会活动分布'}}"
          height="{{320}}"
          bind:chartTap="onPieChartTap"
        />
      </view>

      <!-- 柱状图 -->
      <view class="chart-container">
        <bar-chart
          data="{{barChartData}}"
          title="{{dataType === 'user' ? '协会管理员数量' : '活动签到排行'}}"
          height="{{300}}"
          barColor="#1989fa"
          bind:chartTap="onBarChartTap"
        />
      </view>
    </view>

    <!-- 详细数据表格 -->
    <view class="table-section">
      <view class="section-title">
        <van-icon name="records" size="20px" color="#df76b0" />
        <text>详细数据</text>
      </view>
      
      <!-- 用户数据表格 -->
      <view class="data-table" wx:if="{{dataType === 'user'}}">
        <view class="table-header">
          <view class="header-cell">协会名称</view>
          <view class="header-cell">总人数</view>
          <view class="header-cell">男性</view>
          <view class="header-cell">女性</view>
          <view class="header-cell">管理员</view>
          <view class="header-cell">新会员</view>
        </view>
        <scroll-view class="table-body" scroll-y>
          <view 
            class="table-row" 
            wx:for="{{userStats.clubs}}" 
            wx:key="club_id"
          >
            <view class="table-cell club-name">{{item.club_name}}</view>
            <view class="table-cell">{{item.total_count}}</view>
            <view class="table-cell">{{item.male_count}}</view>
            <view class="table-cell">{{item.female_count}}</view>
            <view class="table-cell">{{item.admin_count}}</view>
            <view class="table-cell">{{item.new_member_count}}</view>
          </view>
        </scroll-view>
      </view>

      <!-- 活动数据表格 -->
      <view class="data-table" wx:else>
        <view class="table-header">
          <view class="header-cell">活动名称</view>
          <view class="header-cell">协会</view>
          <view class="header-cell">地点</view>
          <view class="header-cell">报名数</view>
          <view class="header-cell">签到数</view>
          <view class="header-cell">签到率</view>
        </view>
        <scroll-view class="table-body" scroll-y>
          <view 
            class="table-row" 
            wx:for="{{eventStats.events}}" 
            wx:key="event_id"
          >
            <view class="table-cell event-title">{{item.title}}</view>
            <view class="table-cell">{{item.club_name}}</view>
            <view class="table-cell">{{item.location_name}}</view>
            <view class="table-cell">{{item.total_participants}}</view>
            <view class="table-cell">{{item.checked_in_count}}</view>
            <view class="table-cell rate-cell">
              {{item.total_participants > 0 ? Math.round((item.checked_in_count / item.total_participants) * 100) : 0}}%
            </view>
          </view>
        </scroll-view>
      </view>
    </view>

    <!-- 操作按钮区域 -->
    <view class="actions-section">
      <van-button
        type="primary"
        size="large"
        icon="download"
        block
        bind:click="onExportData"
      >
        导出 {{dataType === 'user' ? '用户' : '活动'}} 数据
      </van-button>
      
      <van-button
        type="default"
        size="large"
        icon="refresh"
        block
        bind:click="loadAllData"
        style="margin-top: 20rpx;"
      >
        刷新数据
      </van-button>
    </view>
  </view>

  <!-- 悬浮刷新按钮 -->
  <view class="float-refresh" wx:if="{{!loading && !error}}" bindtap="loadAllData">
    <van-icon name="refresh" size="24px" color="#fff" />
  </view>
</view>
